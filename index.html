<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Pro AI - Análise Inteligente com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .step-active { border-color: #667eea; background: rgba(102, 126, 234, 0.1); }
        .input-field { transition: all 0.3s; }
        .input-field:focus { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(102, 126, 234, 0.3); }
        .hidden-section { display: none; }
        .visible-section { display: block; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat Interface */
        .chat-container { height: 500px; overflow-y: auto; scroll-behavior: smooth; }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .typing-indicator::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
        
        .insight-card { transition: all 0.3s; border-left: 3px solid transparent; }
        .insight-card:hover { transform: translateX(5px); border-left-color: #667eea; }
        .risk-high { border-left-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1); }
        .risk-medium { border-left-color: #f59e0b !important; background: rgba(245, 158, 11, 0.1); }
        .risk-low { border-left-color: #10b981 !important; background: rgba(16, 185, 129, 0.1); }
        
        .pulse-ring { position: relative; }
        .pulse-ring::before { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 2px solid #10b981; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 w-full bg-slate-950/90 backdrop-blur-md border-b border-slate-800 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-xl">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold gradient-text">Valuation Pro AI</h1>
                    <p class="text-xs text-slate-400">Powered by GPT-4</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAIConfig()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                    <i class="fas fa-key mr-2"></i>Configurar IA
                </button>
                <div class="text-sm text-slate-400 hidden md:block">
                    <span id="aiStatus" class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                        IA Desconectada
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- AI Configuration Modal -->
    <div id="aiConfigModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-2xl font-bold mb-4 gradient-text">Configurar Integração com IA</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">Provedor de IA</label>
                    <select id="aiProvider" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500" onchange="updateAIFields()">
                        <option value="openai">OpenAI (ChatGPT) - Recomendado</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="grok">xAI (Grok) - Em breve</option>
                        <option value="local">Modelo Local (Ollama)</option>
                    </select>
                </div>

                <div id="apiKeyContainer">
                    <label class="block text-sm font-medium mb-2 text-slate-300">API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 pr-10" placeholder="sk-...">
                        <button onclick="toggleApiVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Sua chave fica apenas no seu navegador, não é enviada para nossos servidores.</p>
                </div>

                <div id="modelContainer">
                    <label class="block text-sm font-medium mb-2 text-slate-300">Modelo</label>
                    <select id="aiModel" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                        <option value="gpt-4">GPT-4 (Mais inteligente)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Mais rápido/barato)</option>
                        <option value="gpt-4-turbo-preview">GPT-4 Turbo (Novo)</option>
                    </select>
                </div>

                <div class="p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                    <h4 class="text-blue-400 font-semibold mb-2 text-sm">Como obter sua API Key:</h4>
                    <ol class="text-xs text-slate-400 space-y-1 list-decimal list-inside" id="apiInstructions">
                        <li>Acesse platform.openai.com</li>
                        <li>Crie uma conta ou faça login</li>
                        <li>Vá em "API Keys" no menu lateral</li>
                        <li>Clique em "Create new secret key"</li>
                        <li>Copie e cole aqui (custo ~$0.01-0.03 por análise)</li>
                    </ol>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeAIConfig()" class="flex-1 border border-slate-600 hover:bg-slate-800 text-white font-semibold py-3 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button onclick="saveAIConfig()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 rounded-lg transition-all">
                        Salvar e Conectar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="fixed top-16 w-full bg-slate-900 h-1 z-40">
        <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style="width: 0%"></div>
    </div>

    <!-- Main Container -->
    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto">
        
        <!-- Step Indicator -->
        <div class="flex justify-between mb-8 text-sm overflow-x-auto">
            <div id="step1-indicator" class="step-active px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">1. Dados</div>
            <div id="step2-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">2. Projeções</div>
            <div id="step3-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">3. WACC</div>
            <div id="step4-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">4. Resultado</div>
            <div id="step5-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">5. Análise IA</div>
        </div>

        <!-- STEP 1: Company Data -->
        <section id="step1" class="visible-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Dados da Empresa</h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Nome da Empresa</label>
                        <input type="text" id="companyName" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Ex: Tech Solutions Ltda">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Setor</label>
                        <select id="sector" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Selecione...</option>
                            <option value="tecnologia">Tecnologia / SaaS</option>
                            <option value="varejo">Varejo / E-commerce</option>
                            <option value="industria">Indústria / Manufatura</option>
                            <option value="servicos">Serviços / Consultoria</option>
                            <option value="saude">Saúde / Biotech</option>
                            <option value="financeiro">Fintech / Banco</option>
                            <option value="energia">Energia / Sustentabilidade</option>
                            <option value="alimentos">Food / Bev / Agronegócio</option>
                            <option value="construcao">Construção / Imobiliário</option>
                            <option value="educacao">Educação / EdTech</option>
                            <option value="logistica">Logística / Transporte</option>
                            <option value="outro">Outro / Diverso</option>
                        </select>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep(2)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Próximo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 2: Historical & Projections -->
        <section id="step2" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold gradient-text">Dados Financeiros</h2>
                    <button onclick="autoFillData()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                        <i class="fas fa-magic mr-2"></i>Preencher com IA (Simulação)
                    </button>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <label class="block text-xs font-medium mb-1 text-slate-400">Receita Ano Atual (R$)</label>
                        <input type="number" id="currentRevenue" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0,00" step="0.01">
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <label class="block text-xs font-medium mb-1 text-slate-400">Margem EBITDA (%)</label>
                        <input type="number" id="currentMargin" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0,00" step="0.01">
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <label class="block text-xs font-medium mb-1 text-slate-400">Crescimento Esperado (% ao ano)</label>
                        <input type="number" id="growthRate" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0,00" step="0.01">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <label class="block text-xs font-medium mb-1 text-slate-400">Investimento em CAPEX (% Receita)</label>
                        <input type="number" id="capexRate" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5-15%" step="0.01">
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <label class="block text-xs font-medium mb-1 text-slate-400">Necessidade de Capital de Giro (% Receita)</label>
                        <input type="number" id="ncgRate" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="10-20%" step="0.01">
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep(1)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button onclick="nextStep(3)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Próximo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 3: WACC -->
        <section id="step3" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Custo de Capital (WACC)</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-blue-400">Capital Próprio</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Taxa Livre de Risco (%)</label>
                            <input type="number" id="rf" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="11.75" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Prêmio de Risco (%)</label>
                            <input type="number" id="rpm" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="6.0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Beta</label>
                            <input type="number" id="beta" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="1.0" step="0.01">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-purple-400">Capital de Terceiros</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Custo da Dívida (%)</label>
                            <input type="number" id="kd" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="12.0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Participação da Dívida (%)</label>
                            <input type="number" id="debtWeight" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="30" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Crescimento Perpétuo (%)</label>
                            <input type="number" id="growthPerp" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="3.0" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-slate-300">WACC Calculado:</span>
                        <span class="text-3xl font-bold gradient-text mono" id="waccDisplay">-</span>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep(2)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button onclick="calculateValuation(); nextStep(4)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Calcular Valuation <i class="fas fa-calculator ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 4: Results -->
        <section id="step4" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Resultado do Valuation</h2>
                
                <div class="grid md:grid-cols-3 gap-4 mb-8">
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">Enterprise Value</h4>
                        <p class="text-3xl font-bold text-blue-400 mono" id="evResult">-</p>
                    </div>
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">Valor por Ação*</h4>
                        <p class="text-3xl font-bold text-purple-400 mono" id="valuePerShare">-</p>
                        <p class="text-xs text-slate-500 mt-1">*Se houver capital social definido</p>
                    </div>
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">EV/EBITDA</h4>
                        <p class="text-3xl font-bold text-green-400 mono" id="evEbitdaMultiple">-</p>
                    </div>
                </div>

                <div class="glass p-6 rounded-xl border border-slate-800 mb-6">
                    <h4 class="text-lg font-semibold mb-4 text-slate-300">Fluxo de Caixa Projetado (5 anos)</h4>
                    <canvas id="fcfChart" height="100"></canvas>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button onclick="prevStep(3)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Ajustar Dados
                    </button>
                    <button onclick="prepareAIAnalysis(); nextStep(5)" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg shadow-green-500/25">
                        <i class="fas fa-robot mr-2"></i>Analisar com IA <i class="fas fa-wand-magic-sparkles ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 5: AI Analysis -->
        <section id="step5" class="hidden-section">
            <div class="grid lg:grid-cols-2 gap-6">
                
                <!-- Chat Interface -->
                <div class="glass rounded-2xl p-6 border border-slate-800 flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-800">
                        <h3 class="text-xl font-bold gradient-text flex items-center gap-2">
                            <i class="fas fa-brain"></i> Consultor IA
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="requestAnalysis('critique')" class="text-xs bg-red-500/20 text-red-400 hover:bg-red-500/30 px-3 py-1 rounded-full transition-colors border border-red-500/30">
                                <i class="fas fa-search mr-1"></i>Criticar
                            </button>
                            <button onclick="requestAnalysis('optimize')" class="text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 px-3 py-1 rounded-full transition-colors border border-blue-500/30">
                                <i class="fas fa-chart-line mr-1"></i>Otimizar
                            </button>
                            <button onclick="requestAnalysis('compare')" class="text-xs bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 px-3 py-1 rounded-full transition-colors border border-purple-500/30">
                                <i class="fas fa-balance-scale mr-1"></i>Comparar
                            </button>
                        </div>
                    </div>

                    <div id="chatContainer" class="chat-container flex-1 space-y-4 mb-4 pr-2">
                        <!-- Mensagens aparecem aqui -->
                        <div class="chat-message bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-300">
                                        Olá! Sou seu consultor de valuation. Posso ajudar você a:
                                    </p>
                                    <ul class="text-sm text-slate-400 mt-2 space-y-1 list-disc list-inside">
                                        <li>Identificar riscos e oportunidades no modelo</li>
                                        <li>Sugerir melhorias nas projeções</li>
                                        <li>Comparar com benchmarks do setor</li>
                                        <li>Explicar sensitividades e cenários</li>
                                    </ul>
                                    <p class="text-sm text-slate-400 mt-2">
                                        Clique nos botões acima ou digite sua pergunta abaixo.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative">
                        <input type="text" id="userInput" placeholder="Pergunte algo sobre o valuation..." 
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-white focus:outline-none focus:border-blue-500"
                            onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center justify-center transition-colors">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="space-y-4">
                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-400"></i> Insights Automáticos
                        </h3>
                        <div id="insightsContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-8">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Aguardando análise da IA...
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-orange-400"></i> Alertas de Risco
                        </h3>
                        <div id="risksContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-4">
                                Análise de riscos pendente
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-trophy text-green-400"></i> Oportunidades
                        </h3>
                        <div id="opportunitiesContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-4">
                                Análise de oportunidades pendente
                            </div>
                        </div>
                    </div>

                    <button onclick="generateFullReport()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        <i class="fas fa-file-pdf mr-2"></i>Gerar Relatório Completo com IA
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="location.reload()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-redo mr-2"></i>Novo Valuation
                </button>
            </div>
        </section>
    </main>

    <script>
        // Global State
        let currentStep = 1;
        let valuationData = {};
        let aiConfig = {
            provider: 'openai',
            apiKey: '',
            model: 'gpt-4',
            connected: false
        };
        let chatHistory = [];

        // Navigation
        function nextStep(step) {
            document.querySelectorAll('section').forEach(s => {
                s.classList.remove('visible-section');
                s.classList.add('hidden-section');
            });
            document.querySelectorAll('[id^="step"][id$="-indicator"]').forEach(ind => {
                ind.classList.remove('step-active');
            });
            
            document.getElementById(`step${step}`).classList.remove('hidden-section');
            document.getElementById(`step${step}`).classList.add('visible-section');
            document.getElementById(`step${step}-indicator`).classList.add('step-active');
            
            document.getElementById('progressBar').style.width = `${(step-1)*25}%`;
            currentStep = step;
        }

        function prevStep(step) {
            nextStep(step);
        }

        // AI Configuration
        function toggleAIConfig() {
            const modal = document.getElementById('aiConfigModal');
            modal.classList.toggle('hidden');
        }

        function closeAIConfig() {
            document.getElementById('aiConfigModal').classList.add('hidden');
        }

        function toggleApiVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function updateAIFields() {
            const provider = document.getElementById('aiProvider').value;
            const instructions = document.getElementById('apiInstructions');
            const modelSelect = document.getElementById('aiModel');
            
            if (provider === 'openai') {
                instructions.innerHTML = `
                    <li>Acesse platform.openai.com</li>
                    <li>Crie uma conta ou faça login</li>
                    <li>Vá em "API Keys" no menu lateral</li>
                    <li>Clique em "Create new secret key"</li>
                    <li>Copie e cole aqui (custo ~$0.01-0.03 por análise)</li>
                `;
                modelSelect.innerHTML = `
                    <option value="gpt-4">GPT-4 (Mais inteligente)</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Mais rápido/barato)</option>
                    <option value="gpt-4-turbo-preview">GPT-4 Turbo (Novo)</option>
                `;
            } else if (provider === 'anthropic') {
                instructions.innerHTML = `
                    <li>Acesse console.anthropic.com</li>
                    <li>Crie uma conta</li>
                    <li>Vá em "API Keys"</li>
                    <li>Gere uma nova chave</li>
                    <li>Copie e cole aqui</li>
                `;
                modelSelect.innerHTML = `
                    <option value="claude-3-opus-20240229">Claude 3 Opus (Melhor)</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Equilibrado)</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku (Rápido)</option>
                `;
            }
        }

        function saveAIConfig() {
            aiConfig.provider = document.getElementById('aiProvider').value;
            aiConfig.apiKey = document.getElementById('apiKey').value;
            aiConfig.model = document.getElementById('aiModel').value;
            aiConfig.connected = true;
            
            document.getElementById('aiStatus').innerHTML = `
                <span class="pulse-ring w-2 h-2 bg-green-500 rounded-full block"></span>
                <span class="text-green-400">IA Conectada (${aiConfig.model})</span>
            `;
            
            closeAIConfig();
            
            // Test connection
            testAIConnection();
        }

        async function testAIConnection() {
            try {
                const response = await callAI('Diga apenas "Conexão estabelecida com sucesso" em português.', true);
                console.log('AI Connected:', response);
            } catch (e) {
                console.error('AI Connection failed:', e);
                alert('Erro na conexão com a IA. Verifique sua API Key.');
                aiConfig.connected = false;
            }
        }

        // Valuation Calculations
        function calculateValuation() {
            const revenue = parseFloat(document.getElementById('currentRevenue').value) || 0;
            const margin = parseFloat(document.getElementById('currentMargin').value) || 0;
            const growth = parseFloat(document.getElementById('growthRate').value) || 0;
            const capexRate = parseFloat(document.getElementById('capexRate').value) || 0;
            const ncgRate = parseFloat(document.getElementById('ncgRate').value) || 0;
            
            const rf = parseFloat(document.getElementById('rf').value) || 0;
            const rpm = parseFloat(document.getElementById('rpm').value) || 0;
            const beta = parseFloat(document.getElementById('beta').value) || 0;
            const kd = parseFloat(document.getElementById('kd').value) || 0;
            const debtWeight = parseFloat(document.getElementById('debtWeight').value) || 0;
            const growthPerp = parseFloat(document.getElementById('growthPerp').value) || 0;
            
            const ke = rf + (beta * rpm);
            const kdAfterTax = kd * (1 - 0.34);
            const equityWeight = 100 - debtWeight;
            const wacc = ((equityWeight/100) * ke) + ((debtWeight/100) * kdAfterTax);
            
            document.getElementById('waccDisplay').textContent = wacc.toFixed(2) + '%';
            
            // Project FCF for 5 years
            let fcfs = [];
            let revenues = [revenue];
            let details = [];
            
            for (let i = 0; i < 5; i++) {
                const rev = revenues[i] * (1 + growth/100);
                const ebitda = rev * (margin/100);
                const dep = rev * 0.05;
                const ebit = ebitda - dep;
                const tax = ebit * 0.34;
                const nopat = ebit - tax;
                const capex = rev * (capexRate/100);
                const ncg = rev * (ncgRate/100) * (growth/100);
                const fcf = nopat + dep - capex - ncg;
                
                revenues.push(rev);
                fcfs.push(fcf);
                details.push({rev, ebitda, fcf});
            }
            
            // Terminal Value
            const terminalFCF = fcfs[4] * (1 + growthPerp/100);
            const terminalValue = terminalFCF / ((wacc/100) - (growthPerp/100));
            
            // NPV
            let npv = 0;
            fcfs.forEach((fcf, i) => {
                npv += fcf / Math.pow(1 + wacc/100, i+1);
            });
            const pvTerminal = terminalValue / Math.pow(1 + wacc/100, 5);
            const enterpriseValue = npv + pvTerminal;
            
            // Update UI
            document.getElementById('evResult').textContent = 'R$ ' + (enterpriseValue/1000000).toFixed(2) + 'M';
            document.getElementById('valuePerShare').textContent = 'R$ ' + ((enterpriseValue/1000000)/10).toFixed(2); // Assuming 10M shares
            document.getElementById('evEbitdaMultiple').textContent = (enterpriseValue/details[4].ebitda).toFixed(2) + 'x';
            
            // Chart
            const ctx = document.getElementById('fcfChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ano 1', 'Ano 2', 'Ano 3', 'Ano 4', 'Ano 5'],
                    datasets: [{
                        label: 'FCF (R$ mil)',
                        data: fcfs.map(f => f/1000),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Store data
            valuationData = {
                company: document.getElementById('companyName').value,
                sector: document.getElementById('sector').value,
                revenue, margin, growth, capexRate, ncgRate,
                wacc, ke, kd: kdAfterTax, growthPerp,
                fcfs, terminalValue, enterpriseValue,
                details, equityWeight, debtWeight
            };
        }

        function prepareAIAnalysis() {
            if (!aiConfig.connected) {
                if (confirm('Você precisa configurar a API da IA primeiro. Deseja configurar agora?')) {
                    toggleAIConfig();
                }
                return;
            }
            
            // Auto-request initial analysis
            setTimeout(() => {
                requestAnalysis('full');
            }, 500);
        }

        // AI Integration
        async function callAI(prompt, isTest = false) {
            if (!aiConfig.connected && !isTest) {
                throw new Error('IA não configurada');
            }
            
            const messages = [
                {
                    role: 'system',
                    content: `Você é um consultor sênior de valuation e M&A com 20 anos de experiência. 
                    Analise o valuation apresentado de forma crítica, profissional e construtiva.
                    Responda em português do Brasil. Seja direto, técnico mas acessível.`
                },
                {
                    role: 'user',
                    content: prompt
                }
            ];
            
            if (aiConfig.provider === 'openai') {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro na API');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } else if (aiConfig.provider === 'anthropic') {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': aiConfig.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        max_tokens: 2000,
                        messages: messages
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro na API');
                }
                
                const data = await response.json();
                return data.content[0].text;
            }
            
            throw new Error('Provedor não suportado');
        }

        async function requestAnalysis(type) {
            if (!valuationData.enterpriseValue) {
                alert('Calcule o valuation primeiro!');
                return;
            }
            
            const loadingId = addMessage('ai', '<span class="typing-indicator">Analisando</span>');
            
            try {
                let prompt = '';
                const data = valuationData;
                
                switch(type) {
                    case 'critique':
                        prompt = `Critique severamente este valuation da empresa ${data.company} (setor: ${data.sector}):
                        
                        DADOS:
                        - Receita atual: R$ ${(data.revenue/1000000).toFixed(2)}M
                        - Margem EBITDA: ${data.margin}%
                        - Crescimento projetado: ${data.growth}% ao ano
                        - WACC: ${data.wacc.toFixed(2)}%
                        - EV calculado: R$ ${(data.enterpriseValue/1000000).toFixed(2)}M
                        - Múltiplo EV/EBITDA: ${(data.enterpriseValue/data.details[4].ebitda).toFixed(2)}x
                        
                        Identifique:
                        1. Suposições otimistas ou irreais
                        2. Riscos não considerados
                        3. Erros metodológicos
                        4. Sensibilidades críticas
                        
                        Seja direto e crítico, mas construtivo.`;
                        break;
                        
                    case 'optimize':
                        prompt = `Como otimizar este valuation da empresa ${data.company}?
                        
                        Cenário atual: EV de R$ ${(data.enterpriseValue/1000000).toFixed(2)}M
                        
                        Sugira:
                        1. Alavancas operacionais para aumentar valor (margem, crescimento, capital de giro)
                        2. Estrutura de capital ótima (WACC atual: ${data.wacc.toFixed(2)}%)
                        3. Estratégias de criação de valor
                        4. Cenários alternativos (bull, base, bear)
                        
                        Quantifique o impacto de cada sugestão no valuation.`;
                        break;
                        
                    case 'compare':
                        prompt = `Compare este valuation com benchmarks de mercado:
                        
                        Empresa: ${data.company}
                        Setor: ${data.sector}
                        Múltiplo EV/EBITDA: ${(data.enterpriseValue/data.details[4].ebitda).toFixed(2)}x
                        Crescimento: ${data.growth}%
                        Margem: ${data.margin}%
                        
                        Forneça:
                        1. Múltiplos médios do setor ${data.sector}
                        2. Comparação com empresas similares
                        3. Análise de premium/discount
                        4. Justificativa para o múltiplo calculado`;
                        break;
                        
                    case 'full':
                    default:
                        prompt = `Análise completa de valuation:
                        
                        EMPRESA: ${data.company}
                        SETOR: ${data.sector}
                        
                        PREMISSAS:
                        - Receita: R$ ${(data.revenue/1000000).toFixed(2)}M
                        - Crescimento: ${data.growth}% (5 anos)
                        - Margem EBITDA: ${data.margin}%
                        - CAPEX: ${data.capexRate}% da receita
                        - NCG: ${data.ncgRate}% da receita
                        - WACC: ${data.wacc.toFixed(2)}%
                        - Ke: ${data.ke.toFixed(2)}% | Kd: ${data.kd.toFixed(2)}%
                        - Crescimento perpétuo: ${data.growthPerp}%
                        
                        RESULTADO:
                        - Enterprise Value: R$ ${(data.enterpriseValue/1000000).toFixed(2)}M
                        - Valor Terminal: R$ ${(data.terminalValue/1000000).toFixed(2)}M
                        - FCF médio: R$ ${(data.fcfs.reduce((a,b)=>a+b,0)/5/1000000).toFixed(2)}M
                        
                        Forneça:
                        1. Avaliação geral da qualidade do modelo (nota 0-10)
                        2. Principais riscos (alto/médio/baixo)
                        3. Oportunidades de melhoria
                        4. Fair value range (cenários pessimista, base, otimista)`;
                }
                
                const response = await callAI(prompt);
                removeMessage(loadingId);
                addMessage('ai', response);
                
                // Parse insights for side panel
                parseInsights(response, type);
                
            } catch (error) {
                removeMessage(loadingId);
                addMessage('ai', `Erro: ${error.message}. Verifique sua API Key ou tente novamente.`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            
            addMessage('user', text);
            input.value = '';
            
            const loadingId = addMessage('ai', '<span class="typing-indicator">Pensando</span>');
            
            try {
                const context = `Contexto do valuation atual:
                Empresa: ${valuationData.company || 'N/A'}
                Setor: ${valuationData.sector || 'N/A'}
                EV Calculado: R$ ${((valuationData.enterpriseValue || 0)/1000000).toFixed(2)}M
                WACC: ${(valuationData.wacc || 0).toFixed(2)}%
                
                Pergunta do usuário: ${text}`;
                
                const response = await callAI(context);
                removeMessage(loadingId);
                addMessage('ai', response);
                
            } catch (error) {
                removeMessage(loadingId);
                addMessage('ai', `Erro: ${error.message}`);
            }
        }

        // Chat UI Helpers
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-message ' + (role === 'user' ? 'ml-12' : '');
            
            const isUser = role === 'user';
            div.innerHTML = `
                <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-full ${isUser ? 'bg-slate-700' : 'bg-gradient-to-br from-blue-500 to-purple-600'} flex items-center justify-center flex-shrink-0">
                        <i class="fas ${isUser ? 'fa-user' : 'fa-robot'} text-xs"></i>
                    </div>
                    <div class="flex-1 ${isUser ? 'text-right' : ''}">
                        <div class="inline-block max-w-full ${isUser ? 'bg-blue-600' : 'bg-slate-800'} p-4 rounded-xl border ${isUser ? 'border-blue-500' : 'border-slate-700'} text-sm text-slate-200 whitespace-pre-wrap">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function parseInsights(text, type) {
            // Simple parsing to populate side panels
            const insightsContainer = document.getElementById('insightsContainer');
            const risksContainer = document.getElementById('risksContainer');
            const opportunitiesContainer = document.getElementById('opportunitiesContainer');
            
            // Clear loading states
            insightsContainer.innerHTML = '';
            risksContainer.innerHTML = '';
            opportunitiesContainer.innerHTML = '';
            
            // Extract numbered items or bullet points
            const lines = text.split('\n').filter(l => l.trim());
            
            lines.forEach(line => {
                if (line.match(/risco|problema|preocupação|alerta/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card risk-high p-3 rounded-lg';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line.replace(/^[0-9.-]+\s*/, '')}</p>`;
                    risksContainer.appendChild(div);
                } else if (line.match(/oportunidade|melhoria|otimizar|aumentar|estratégia/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card risk-low p-3 rounded-lg';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line.replace(/^[0-9.-]+\s*/, '')}</p>`;
                    opportunitiesContainer.appendChild(div);
                } else if (line.match(/nota|score|avaliação|conclusão|recomendação/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card p-3 rounded-lg bg-blue-500/10 border-l-2 border-blue-500';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line}</p>`;
                    insightsContainer.appendChild(div);
                }
            });
            
            // If no specific parsing worked, add generic cards
            if (risksContainer.children.length === 0) {
                risksContainer.innerHTML = '<div class="text-slate-500 text-sm">Análise detalhada disponível no chat.</div>';
            }
            if (opportunitiesContainer.children.length === 0) {
                opportunitiesContainer.innerHTML = '<div class="text-slate-500 text-sm">Solicite uma análise de otimização no chat.</div>';
            }
        }

        async function generateFullReport() {
            if (!aiConfig.connected) {
                alert('Configure a IA primeiro!');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            btn.disabled = true;
            
            try {
                const prompt = `Gere um relatório profissional de valuation em formato estruturado:
                
                ${JSON.stringify(valuationData, null, 2)}
                
                Estrutura do relatório:
                1. EXECUTIVE SUMMARY (2-3 parágrafos)
                2. PREMISSAS CHAVE (tabela)
                3. ANÁLISE DE SENSIBILIDADE
                4. VALUATION POR MÚLTIPLOS (comparativo de mercado)
                5. RISCOS E MITIGAÇÕES
                6. RECOMENDAÇÃO FINAL (Comprar/Vender/Manter com target price)
                
                Formato: Markdown profissional, pronto para converter em PDF.`;
                
                const report = await callAI(prompt);
                
                // Download as markdown
                const blob = new Blob([report], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Valuation_${valuationData.company.replace(/\s+/g, '_')}_IA.md`;
                a.click();
                
                addMessage('ai', '✅ Relatório completo gerado e baixado! O arquivo está em formato Markdown (MD). Você pode abrir no Word, Google Docs ou converter para PDF.');
                
            } catch (error) {
                alert('Erro ao gerar relatório: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function autoFillData() {
            const sector = document.getElementById('sector').value || 'tecnologia';
            const defaults = {
                tecnologia: { rev: 5000000, margin: 25, growth: 20, capex: 8, ncg: 10, beta: 1.2 },
                varejo: { rev: 10000000, margin: 8, growth: 8, capex: 4, ncg: 15, beta: 0.9 },
                industria: { rev: 20000000, margin: 15, growth: 5, capex: 6, ncg: 20, beta: 1.0 },
                servicos: { rev: 3000000, margin: 20, growth: 12, capex: 3, ncg: 8, beta: 0.8 },
                saude: { rev: 8000000, margin: 22, growth: 10, capex: 5, ncg: 25, beta: 0.7 },
                financeiro: { rev: 15000000, margin: 35, growth: 6, capex: 2, ncg: 0, beta: 1.1 },
                energia: { rev: 50000000, margin: 40, growth: 4, capex: 15, ncg: 5, beta: 0.6 },
                alimentos: { rev: 25000000, margin: 12, growth: 6, capex: 5, ncg: 12, beta: 0.5 },
                construcao: { rev: 40000000, margin: 10, growth: 5, capex: 3, ncg: 30, beta: 1.3 },
                educacao: { rev: 4000000, margin: 18, growth: 15, capex: 4, ncg: 8, beta: 0.9 },
                logistica: { rev: 30000000, margin: 14, growth: 7, capex: 8, ncg: 18, beta: 1.0 },
                outro: { rev: 10000000, margin: 15, growth: 8, capex: 5, ncg: 15, beta: 1.0 }
            };
            
            const d = defaults[sector];
            document.getElementById('currentRevenue').value = d.rev;
            document.getElementById('currentMargin').value = d.margin;
            document.getElementById('growthRate').value = d.growth;
            document.getElementById('capexRate').value = d.capex;
            document.getElementById('ncgRate').value = d.ncg;
            document.getElementById('beta').value = d.beta;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved API key
            const saved = localStorage.getItem('aiConfig');
            if (saved) {
                aiConfig = JSON.parse(saved);
                if (aiConfig.connected) {
                    document.getElementById('aiStatus').innerHTML = `
                        <span class="pulse-ring w-2 h-2 bg-green-500 rounded-full block"></span>
                        <span class="text-green-400">IA Conectada</span>
                    `;
                }
            }
        });

        // Save config to localStorage
        window.addEventListener('beforeunload', () => {
            if (aiConfig.apiKey) {
                localStorage.setItem('aiConfig', JSON.stringify(aiConfig));
            }
        });
    </script>
</body>
</html>
