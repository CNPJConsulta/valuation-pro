<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Pro AI - An√°lise Completa com Dados Hist√≥ricos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .step-active { border-color: #667eea; background: rgba(102, 126, 234, 0.1); }
        .input-field { transition: all 0.3s; }
        .input-field:focus { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(102, 126, 234, 0.3); }
        .hidden-section { display: none; }
        .visible-section { display: block; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-container { height: 500px; overflow-y: auto; scroll-behavior: smooth; }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .typing-indicator::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
        .insight-card { transition: all 0.3s; border-left: 3px solid transparent; }
        .insight-card:hover { transform: translateX(5px); border-left-color: #667eea; }
        .risk-high { border-left-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1); }
        .risk-medium { border-left-color: #f59e0b !important; background: rgba(245, 158, 11, 0.1); }
        .risk-low { border-left-color: #10b981 !important; background: rgba(16, 185, 129, 0.1); }
        .pulse-ring { position: relative; }
        .pulse-ring::before { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 2px solid #10b981; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        .tab-active { border-bottom: 2px solid #667eea; color: #667eea; }
        .year-header { background: rgba(102, 126, 234, 0.1); font-weight: 600; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 w-full bg-slate-950/90 backdrop-blur-md border-b border-slate-800 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-xl">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold gradient-text">Valuation Pro AI</h1>
                    <p class="text-xs text-slate-400">FCF Completo com Proje√ß√µes Vari√°veis</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAIConfig()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                    <i class="fas fa-key mr-2"></i>Configurar IA
                </button>
                <div class="text-sm text-slate-400 hidden md:block">
                    <span id="aiStatus" class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                        IA Desconectada
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- AI Configuration Modal -->
    <div id="aiConfigModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-2xl font-bold mb-4 gradient-text">Configurar Integra√ß√£o com IA</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">Provedor de IA</label>
                    <select id="aiProvider" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500" onchange="updateAIFields()">
                        <option value="openai">OpenAI (ChatGPT) - Recomendado</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                    </select>
                </div>
                <div id="apiKeyContainer">
                    <label class="block text-sm font-medium mb-2 text-slate-300">API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 pr-10" placeholder="sk-...">
                        <button onclick="toggleApiVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Sua chave fica apenas no seu navegador.</p>
                </div>
                <div id="modelContainer">
                    <label class="block text-sm font-medium mb-2 text-slate-300">Modelo</label>
                    <select id="aiModel" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                        <option value="gpt-4">GPT-4 (Mais inteligente)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Mais r√°pido)</option>
                    </select>
                </div>
                <div class="p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                    <h4 class="text-blue-400 font-semibold mb-2 text-sm">Como obter sua API Key:</h4>
                    <ol class="text-xs text-slate-400 space-y-1 list-decimal list-inside" id="apiInstructions">
                        <li>Acesse platform.openai.com</li>
                        <li>Crie uma conta ou fa√ßa login</li>
                        <li>V√° em "API Keys" no menu lateral</li>
                        <li>Clique em "Create new secret key"</li>
                        <li>Copie e cole aqui</li>
                    </ol>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeAIConfig()" class="flex-1 border border-slate-600 hover:bg-slate-800 text-white font-semibold py-3 rounded-lg transition-all">Cancelar</button>
                    <button onclick="saveAIConfig()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 rounded-lg transition-all">Salvar e Conectar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="fixed top-16 w-full bg-slate-900 h-1 z-40">
        <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style="width: 0%"></div>
    </div>

    <!-- Main Container -->
    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto">
        
        <!-- Step Indicator -->
        <div class="flex justify-between mb-8 text-sm overflow-x-auto">
            <div id="step1-indicator" class="step-active px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">1. Identifica√ß√£o</div>
            <div id="step2-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">2. Dados Hist√≥ricos (3 anos)</div>
            <div id="step3-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">3. Proje√ß√µes (5 anos)</div>
            <div id="step4-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">4. WACC</div>
            <div id="step5-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">5. Resultado</div>
            <div id="step6-indicator" class="px-4 py-2 rounded-lg border border-slate-600 transition-all whitespace-nowrap">6. An√°lise IA</div>
        </div>

        <!-- STEP 1: Company Identification -->
        <section id="step1" class="visible-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Identifica√ß√£o da Empresa</h2>
                <p class="text-slate-400 mb-6">Vamos identificar o neg√≥cio para buscar refer√™ncias de mercado quando necess√°rio.</p>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Nome da Empresa</label>
                        <input type="text" id="companyName" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Ex: Tech Solutions Ltda">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Setor de Atua√ß√£o</label>
                        <select id="sector" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Selecione o setor...</option>
                            <option value="tecnologia">Tecnologia / Software</option>
                            <option value="varejo">Varejo / Com√©rcio</option>
                            <option value="industria">Ind√∫stria / Manufatura</option>
                            <option value="servicos">Servi√ßos / Consultoria</option>
                            <option value="saude">Sa√∫de / Farmac√™utico</option>
                            <option value="financeiro">Servi√ßos Financeiros</option>
                            <option value="energia">Energia / Utilidades</option>
                            <option value="alimentos">Alimentos e Bebidas</option>
                            <option value="construcao">Constru√ß√£o Civil</option>
                            <option value="logistica">Log√≠stica / Transporte</option>
                            <option value="educacao">Educa√ß√£o / EdTech</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Ano Base (√∫ltimo ano hist√≥rico)</label>
                        <input type="number" id="baseYear" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500" value="2023" min="2020" max="2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-300">Moeda</label>
                        <select id="currency" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                            <option value="BRL">R$ (Real)</option>
                            <option value="USD">US$ (D√≥lar)</option>
                            <option value="EUR">‚Ç¨ (Euro)</option>
                        </select>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep(2)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Pr√≥ximo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 2: Historical Data (3 Years) -->
        <section id="step2" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold gradient-text">Dados Hist√≥ricos (3 anos)</h2>
                    <button onclick="autoFillHistorical()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                        <i class="fas fa-magic mr-2"></i>Preencher com Refer√™ncias do Setor
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-600">
                                <th class="py-4 px-2 text-slate-400 w-1/4">Indicador</th>
                                <th class="py-4 px-2 text-slate-400 text-center year-header" id="histYear1">2021</th>
                                <th class="py-4 px-2 text-slate-400 text-center year-header" id="histYear2">2022</th>
                                <th class="py-4 px-2 text-slate-400 text-center year-header" id="histYear3">2023</th>
                            </tr>
                        </thead>
                        <tbody class="mono text-sm">
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">Receita L√≠quida</td>
                                <td class="py-3 px-2"><input type="number" id="rev1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="rev2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="rev3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">(-) Custos Operacionais</td>
                                <td class="py-3 px-2"><input type="number" id="cost1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="cost2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="cost3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                            </tr>
                            <tr class="border-b border-slate-700/50 bg-slate-800/30">
                                <td class="py-3 px-2 text-green-400 font-semibold">= EBITDA</td>
                                <td class="py-3 px-2 text-right text-green-400" id="ebitda1">-</td>
                                <td class="py-3 px-2 text-right text-green-400" id="ebitda2">-</td>
                                <td class="py-3 px-2 text-right text-green-400" id="ebitda3">-</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">(-) Deprecia√ß√£o/Amortiza√ß√£o</td>
                                <td class="py-3 px-2"><input type="number" id="dep1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="dep2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                                <td class="py-3 px-2"><input type="number" id="dep3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01" onchange="calculateHistorical()"></td>
                            </tr>
                            <tr class="border-b border-slate-700/50 bg-slate-800/30">
                                <td class="py-3 px-2 text-blue-400 font-semibold">= EBIT</td>
                                <td class="py-3 px-2 text-right text-blue-400" id="ebit1">-</td>
                                <td class="py-3 px-2 text-right text-blue-400" id="ebit2">-</td>
                                <td class="py-3 px-2 text-right text-blue-400" id="ebit3">-</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">(-) Imposto de Renda (IR)</td>
                                <td class="py-3 px-2"><input type="number" id="tax1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="tax2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="tax3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">(+/-) Varia√ß√£o NCG</td>
                                <td class="py-3 px-2"><input type="number" id="ncg1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="ncg2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="ncg3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-3 px-2 text-slate-300">(-) CAPEX (Investimentos)</td>
                                <td class="py-3 px-2"><input type="number" id="capex1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="capex2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                                <td class="py-3 px-2"><input type="number" id="capex3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-right" placeholder="0,00" step="0.01"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Historical Metrics -->
                <div class="grid md:grid-cols-3 gap-4 mt-6">
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <h4 class="text-slate-400 text-xs mb-1">CAGR Receita (3 anos)</h4>
                        <p class="text-2xl font-bold text-blue-400 mono" id="cagrRevenue">-</p>
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <h4 class="text-slate-400 text-xs mb-1">Margem EBITDA M√©dia</h4>
                        <p class="text-2xl font-bold text-green-400 mono" id="avgEbitdaMargin">-</p>
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <h4 class="text-slate-400 text-xs mb-1">Taxa de Investimento (CAPEX/Rev)</h4>
                        <p class="text-2xl font-bold text-purple-400 mono" id="avgCapexRate">-</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                    <h4 class="text-blue-400 font-semibold mb-2 text-sm">üí° Dicas:</h4>
                    <ul class="text-xs text-slate-400 space-y-1">
                        <li>‚Ä¢ <strong>NCG</strong> = (Contas a Receber + Estoques) - (Fornecedores + Obriga√ß√µes)</li>
                        <li>‚Ä¢ <strong>Varia√ß√£o NCG</strong> = NCG deste ano - NCG do ano anterior</li>
                        <li>‚Ä¢ Se NCG aumentou, √© uso de caixa (sinal negativo no FCF)</li>
                    </ul>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep(1)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button onclick="calculateHistorical(); nextStep(3)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Pr√≥ximo: Proje√ß√µes <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 3: Projections (5 Years) - VARIABLE GROWTH -->
        <section id="step3" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold gradient-text">Proje√ß√µes (5 anos) - Crescimento Vari√°vel</h2>
                    <div class="flex gap-2">
                        <button onclick="suggestProjections('conservative')" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-colors border border-slate-700">
                            <i class="fas fa-shield-alt mr-2"></i>Cen√°rio Conservador
                        </button>
                        <button onclick="suggestProjections('base')" class="text-sm bg-blue-800/30 hover:bg-blue-700/30 text-blue-400 px-4 py-2 rounded-lg transition-colors border border-blue-500/30">
                            <i class="fas fa-chart-line mr-2"></i>Cen√°rio Base
                        </button>
                        <button onclick="suggestProjections('optimistic')" class="text-sm bg-green-800/30 hover:bg-green-700/30 text-green-400 px-4 py-2 rounded-lg transition-colors border border-green-500/30">
                            <i class="fas fa-rocket mr-2"></i>Cen√°rio Otimista
                        </button>
                    </div>
                </div>

                <!-- Tabs for each year -->
                <div class="flex border-b border-slate-700 mb-6">
                    <button onclick="showProjectionYear(1)" id="tab-year-1" class="tab-active px-6 py-3 text-sm font-medium transition-colors">Ano 1</button>
                    <button onclick="showProjectionYear(2)" id="tab-year-2" class="px-6 py-3 text-sm font-medium text-slate-400 hover:text-white transition-colors">Ano 2</button>
                    <button onclick="showProjectionYear(3)" id="tab-year-3" class="px-6 py-3 text-sm font-medium text-slate-400 hover:text-white transition-colors">Ano 3</button>
                    <button onclick="showProjectionYear(4)" id="tab-year-4" class="px-6 py-3 text-sm font-medium text-slate-400 hover:text-white transition-colors">Ano 4</button>
                    <button onclick="showProjectionYear(5)" id="tab-year-5" class="px-6 py-3 text-sm font-medium text-slate-400 hover:text-white transition-colors">Ano 5</button>
                </div>

                <!-- Projection Forms for each year -->
                <div id="projection-year-1" class="projection-form">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Crescimento Receita (%)</label>
                            <input type="number" id="growth1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Margem EBITDA (%)</label>
                            <input type="number" id="margin1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Deprecia√ß√£o (% Receita)</label>
                            <input type="number" id="depRate1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">NCG (% Receita)</label>
                            <input type="number" id="ncgRate1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="15.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">CAPEX (% Receita)</label>
                            <input type="number" id="capexRate1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="8.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Al√≠quota IR (%)</label>
                            <input type="number" id="taxRate1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" value="34" step="0.01">
                        </div>
                    </div>
                </div>

                <div id="projection-year-2" class="projection-form hidden">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Crescimento Receita (%)</label>
                            <input type="number" id="growth2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Margem EBITDA (%)</label>
                            <input type="number" id="margin2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Deprecia√ß√£o (% Receita)</label>
                            <input type="number" id="depRate2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">NCG (% Receita)</label>
                            <input type="number" id="ncgRate2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="15.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">CAPEX (% Receita)</label>
                            <input type="number" id="capexRate2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="8.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Al√≠quota IR (%)</label>
                            <input type="number" id="taxRate2" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" value="34" step="0.01">
                        </div>
                    </div>
                </div>

                <div id="projection-year-3" class="projection-form hidden">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Crescimento Receita (%)</label>
                            <input type="number" id="growth3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Margem EBITDA (%)</label>
                            <input type="number" id="margin3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Deprecia√ß√£o (% Receita)</label>
                            <input type="number" id="depRate3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">NCG (% Receita)</label>
                            <input type="number" id="ncgRate3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="15.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">CAPEX (% Receita)</label>
                            <input type="number" id="capexRate3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="8.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Al√≠quota IR (%)</label>
                            <input type="number" id="taxRate3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" value="34" step="0.01">
                        </div>
                    </div>
                </div>

                <div id="projection-year-4" class="projection-form hidden">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Crescimento Receita (%)</label>
                            <input type="number" id="growth4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Margem EBITDA (%)</label>
                            <input type="number" id="margin4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Deprecia√ß√£o (% Receita)</label>
                            <input type="number" id="depRate4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">NCG (% Receita)</label>
                            <input type="number" id="ncgRate4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="15.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">CAPEX (% Receita)</label>
                            <input type="number" id="capexRate4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="8.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Al√≠quota IR (%)</label>
                            <input type="number" id="taxRate4" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" value="34" step="0.01">
                        </div>
                    </div>
                </div>

                <div id="projection-year-5" class="projection-form hidden">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Crescimento Receita (%)</label>
                            <input type="number" id="growth5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Margem EBITDA (%)</label>
                            <input type="number" id="margin5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono text-lg" placeholder="0.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Deprecia√ß√£o (% Receita)</label>
                            <input type="number" id="depRate5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="5.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">NCG (% Receita)</label>
                            <input type="number" id="ncgRate5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="15.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">CAPEX (% Receita)</label>
                            <input type="number" id="capexRate5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" placeholder="8.00" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-xl border border-slate-800">
                            <label class="block text-xs font-medium mb-2 text-slate-400">Al√≠quota IR (%)</label>
                            <input type="number" id="taxRate5" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-right mono" value="34" step="0.01">
                        </div>
                    </div>
                </div>

                <!-- Summary Table -->
                <div class="mt-6 overflow-x-auto">
                    <h4 class="text-sm font-semibold mb-3 text-slate-400">Resumo das Proje√ß√µes</h4>
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="py-2 px-2 text-left text-slate-500">Indicador</th>
                                <th class="py-2 px-2 text-center text-slate-500">Ano 1</th>
                                <th class="py-2 px-2 text-center text-slate-500">Ano 2</th>
                                <th class="py-2 px-2 text-center text-slate-500">Ano 3</th>
                                <th class="py-2 px-2 text-center text-slate-500">Ano 4</th>
                                <th class="py-2 px-2 text-center text-slate-500">Ano 5</th>
                            </tr>
                        </thead>
                        <tbody class="mono text-xs" id="projectionSummary">
                            <tr class="border-b border-slate-800/50">
                                <td class="py-2 px-2 text-slate-400">Crescimento</td>
                                <td class="py-2 px-2 text-center text-blue-400" id="sum-growth1">-</td>
                                <td class="py-2 px-2 text-center text-blue-400" id="sum-growth2">-</td>
                                <td class="py-2 px-2 text-center text-blue-400" id="sum-growth3">-</td>
                                <td class="py-2 px-2 text-center text-blue-400" id="sum-growth4">-</td>
                                <td class="py-2 px-2 text-center text-blue-400" id="sum-growth5">-</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-2 text-slate-400">Margem EBITDA</td>
                                <td class="py-2 px-2 text-center text-green-400" id="sum-margin1">-</td>
                                <td class="py-2 px-2 text-center text-green-400" id="sum-margin2">-</td>
                                <td class="py-2 px-2 text-center text-green-400" id="sum-margin3">-</td>
                                <td class="py-2 px-2 text-center text-green-400" id="sum-margin4">-</td>
                                <td class="py-2 px-2 text-center text-green-400" id="sum-margin5">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep(2)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button onclick="saveProjections(); nextStep(4)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Pr√≥ximo: WACC <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 4: WACC -->
        <section id="step4" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Custo de Capital (WACC)</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-blue-400 border-b border-slate-700 pb-2">Capital Pr√≥prio (Ke)</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Taxa Livre de Risco (Rf) %</label>
                            <input type="number" id="rf" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="11.75" step="0.01">
                            <p class="text-xs text-slate-500 mt-1">Sugest√£o: IPCA + 6% ou taxa de t√≠tulos p√∫blicos</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Pr√™mio de Risco de Mercado (Rm - Rf) %</label>
                            <input type="number" id="rpm" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="6.0" step="0.01">
                            <p class="text-xs text-slate-500 mt-1">Hist√≥rico Brasil: 5-7%</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Beta (Œ≤) do Setor</label>
                            <input type="number" id="beta" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="1.0" step="0.01">
                            <p class="text-xs text-slate-500 mt-1">Mercado = 1.0 | Tecnologia: 1.2 | Utilidades: 0.6</p>
                        </div>
                        <div class="glass p-4 rounded-lg bg-blue-900/20 border-blue-500/30">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Ke (CAPM):</span>
                                <span class="text-2xl font-bold text-blue-400 mono" id="keResult">-</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Ke = Rf + Œ≤ √ó (Rm - Rf)</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-purple-400 border-b border-slate-700 pb-2">Capital de Terceiros (Kd)</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Custo da D√≠vida (%) - Pr√©-fixada</label>
                            <input type="number" id="kd" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="12.0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Al√≠quota Tribut√°ria M√©dia (%)</label>
                            <input type="number" id="taxShield" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="34" step="0.01">
                            <p class="text-xs text-slate-500 mt-1">Benef√≠cio fiscal dos juros (IR)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Participa√ß√£o da D√≠vida (%)</label>
                            <input type="number" id="debtWeight" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value="30" step="0.01">
                        </div>
                        <div class="glass p-4 rounded-lg bg-purple-900/20 border-purple-500/30">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Kd (L√≠quido):</span>
                                <span class="text-2xl font-bold text-purple-400 mono" id="kdResult">-</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Kd = Kd bruto √ó (1 - Taxa IR)</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-slate-300">WACC:</span>
                        <span class="text-3xl font-bold gradient-text mono" id="waccResult">-</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">WACC = (E/V √ó Ke) + (D/V √ó Kd √ó (1 - T))</p>
                </div>

                <div class="mt-6 glass p-6 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4 text-green-400">Crescimento na Perpetuidade (g)</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Taxa de Crescimento Perp√©tuo (%)</label>
                            <input type="number" id="growthPerpetuity" class="input-field w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500" value="3.0" step="0.01">
                            <p class="text-xs text-slate-500 mt-1">Sugest√£o: 2.5% a 4% (pr√≥ximo ao PIB longo prazo)</p>
                        </div>
                        <div class="flex items-center">
                            <div class="text-sm text-slate-400">
                                <p class="mb-2"><strong>Regra importante:</strong> g deve ser menor que WACC</p>
                                <p id="perpetuityCheck" class="text-green-400">‚úì Cen√°rio v√°lido</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep(3)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button onclick="calculateWACC(); nextStep(5)" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                        Calcular Valuation <i class="fas fa-calculator ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 5: Results -->
        <section id="step5" class="hidden-section">
            <div class="glass rounded-2xl p-8 mb-6">
                <h2 class="text-3xl font-bold mb-6 gradient-text">Resultado do Valuation</h2>
                
                <div class="grid md:grid-cols-4 gap-4 mb-8">
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">Enterprise Value (EV)</h4>
                        <p class="text-2xl font-bold text-blue-400 mono" id="evResult">-</p>
                    </div>
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">Valor Terminal</h4>
                        <p class="text-2xl font-bold text-purple-400 mono" id="terminalValueResult">-</p>
                    </div>
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">% do Perp√©tuo</h4>
                        <p class="text-2xl font-bold text-yellow-400 mono" id="perpetuityPercent">-</p>
                    </div>
                    <div class="glass p-6 rounded-xl border border-slate-800 text-center">
                        <h4 class="text-slate-400 text-sm mb-2">EV/EBITDA (Ano 5)</h4>
                        <p class="text-2xl font-bold text-green-400 mono" id="evEbitdaMultiple">-</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <h4 class="text-slate-300 mb-4">Fluxo de Caixa Livre (5 anos)</h4>
                        <canvas id="fcfChart" height="200"></canvas>
                    </div>
                    <div class="glass p-4 rounded-xl border border-slate-800">
                        <h4 class="text-slate-300 mb-4">Composi√ß√£o do Valor</h4>
                        <canvas id="valueChart" height="200"></canvas>
                    </div>
                </div>

                <div class="overflow-x-auto mb-8">
                    <h4 class="text-lg font-semibold mb-4 text-slate-300">Demonstrativo Completo do FCF</h4>
                    <table class="w-full text-left border-collapse text-sm">
                        <thead>
                            <tr class="border-b border-slate-600">
                                <th class="py-3 px-2 text-slate-400">Item</th>
                                <th class="py-3 px-2 text-slate-400 text-right">Ano 1</th>
                                <th class="py-3 px-2 text-slate-400 text-right">Ano 2</th>
                                <th class="py-3 px-2 text-slate-400 text-right">Ano 3</th>
                                <th class="py-3 px-2 text-slate-400 text-right">Ano 4</th>
                                <th class="py-3 px-2 text-slate-400 text-right">Ano 5</th>
                            </tr>
                        </thead>
                        <tbody id="fcfTableBody" class="mono">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="glass p-6 rounded-xl border border-slate-700 mb-8">
                    <h4 class="text-lg font-semibold mb-4 text-slate-300">An√°lise de Sensibilidade (EV em milh√µes R$)</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center text-sm" id="sensibilityTable">
                            <!-- Populated by JS -->
                        </table>
                    </div>
                    <p class="text-xs text-slate-500 mt-4">Linhas: WACC | Colunas: Crescimento Perp√©tuo</p>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button onclick="prevStep(4)" class="border border-slate-600 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Ajustar Par√¢metros
                    </button>
                    <button onclick="prepareAIAnalysis(); nextStep(6)" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg shadow-green-500/25">
                        <i class="fas fa-robot mr-2"></i>Analisar com IA <i class="fas fa-wand-magic-sparkles ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 6: AI Analysis -->
        <section id="step6" class="hidden-section">
            <div class="grid lg:grid-cols-2 gap-6">
                
                <!-- Chat Interface -->
                <div class="glass rounded-2xl p-6 border border-slate-800 flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-800">
                        <h3 class="text-xl font-bold gradient-text flex items-center gap-2">
                            <i class="fas fa-brain"></i> Consultor de Valuation IA
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="requestAnalysis('critique')" class="text-xs bg-red-500/20 text-red-400 hover:bg-red-500/30 px-3 py-1 rounded-full transition-colors border border-red-500/30">
                                <i class="fas fa-search mr-1"></i>Criticar
                            </button>
                            <button onclick="requestAnalysis('optimize')" class="text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 px-3 py-1 rounded-full transition-colors border border-blue-500/30">
                                <i class="fas fa-chart-line mr-1"></i>Otimizar
                            </button>
                            <button onclick="requestAnalysis('scenarios')" class="text-xs bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 px-3 py-1 rounded-full transition-colors border border-purple-500/30">
                                <i class="fas fa-random mr-1"></i>Cen√°rios
                            </button>
                        </div>
                    </div>

                    <div id="chatContainer" class="chat-container flex-1 space-y-4 mb-4 pr-2">
                        <div class="chat-message bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-300">
                                        Ol√°! Sou seu consultor de valuation especializado. Analisarei:
                                    </p>
                                    <ul class="text-sm text-slate-400 mt-2 space-y-1 list-disc list-inside">
                                        <li>Qualidade das premissas hist√≥ricas</li>
                                        <li>Realismo das proje√ß√µes vari√°veis</li>
                                        <li>Sensibilidade aos principais drivers</li>
                                        <li>Benchmarks com empresas do setor</li>
                                    </ul>
                                    <p class="text-sm text-slate-400 mt-2">
                                        Clique nos bot√µes acima ou fa√ßa perguntas espec√≠ficas.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative">
                        <input type="text" id="userInput" placeholder="Ex: 'O que acha do crescimento do ano 3?'..." 
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-white focus:outline-none focus:border-blue-500"
                            onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center justify-center transition-colors">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="space-y-4">
                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-400"></i> Insights Autom√°ticos
                        </h3>
                        <div id="insightsContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-8">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Aguardando an√°lise da IA...
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-orange-400"></i> Alertas de Risco
                        </h3>
                        <div id="risksContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-4">
                                An√°lise de riscos pendente
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 border border-slate-800">
                        <h3 class="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                            <i class="fas fa-trophy text-green-400"></i> Oportunidades de Valoriza√ß√£o
                        </h3>
                        <div id="opportunitiesContainer" class="space-y-3">
                            <div class="text-slate-500 text-center py-4">
                                An√°lise de oportunidades pendente
                            </div>
                        </div>
                    </div>

                    <button onclick="generateFullReport()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        <i class="fas fa-file-pdf mr-2"></i>Gerar Relat√≥rio Completo com IA
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="location.reload()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-redo mr-2"></i>Novo Valuation
                </button>
            </div>
        </section>
    </main>

    <script>
        // Global State
        let currentStep = 1;
        let historicalData = {};
        let projections = {};
        let wacc = 0;
        let ke = 0;
        let kd = 0;
        let valuationData = {};
        let aiConfig = { provider: 'openai', apiKey: '', model: 'gpt-4', connected: false };
        let fcfChartInstance = null;
        let valueChartInstance = null;

        // Sector reference data
        const sectorData = {
            tecnologia: { growth: 20, margin: 25, beta: 1.2, capex: 8, ncg: 10, dep: 5 },
            varejo: { growth: 8, margin: 8, beta: 0.9, capex: 4, ncg: 15, dep: 4 },
            industria: { growth: 5, margin: 15, beta: 1.0, capex: 6, ncg: 20, dep: 6 },
            servicos: { growth: 12, margin: 18, beta: 0.8, capex: 3, ncg: 8, dep: 4 },
            saude: { growth: 10, margin: 20, beta: 0.7, capex: 5, ncg: 25, dep: 5 },
            financeiro: { growth: 6, margin: 30, beta: 1.1, capex: 2, ncg: 0, dep: 3 },
            energia: { growth: 4, margin: 35, beta: 0.6, capex: 15, ncg: 5, dep: 8 },
            alimentos: { growth: 6, margin: 12, beta: 0.5, capex: 5, ncg: 12, dep: 5 },
            construcao: { growth: 5, margin: 10, beta: 1.3, capex: 3, ncg: 30, dep: 4 },
            logistica: { growth: 7, margin: 14, beta: 1.0, capex: 8, ncg: 18, dep: 6 },
            educacao: { growth: 15, margin: 18, beta: 0.9, capex: 4, ncg: 8, dep: 4 },
            outro: { growth: 5, margin: 15, beta: 1.0, capex: 5, ncg: 15, dep: 5 }
        };

        // Navigation
        function nextStep(step) {
            document.querySelectorAll('section').forEach(s => {
                s.classList.remove('visible-section');
                s.classList.add('hidden-section');
            });
            document.querySelectorAll('[id^="step"][id$="-indicator"]').forEach(ind => {
                ind.classList.remove('step-active');
            });
            
            document.getElementById(`step${step}`).classList.remove('hidden-section');
            document.getElementById(`step${step}`).classList.add('visible-section');
            document.getElementById(`step${step}-indicator`).classList.add('step-active');
            
            document.getElementById('progressBar').style.width = `${(step-1)*20}%`;
            currentStep = step;

            if (step === 2) setupHistoricalYears();
            if (step === 4) calculateWACC();
        }

        function prevStep(step) {
            nextStep(step);
        }

        function setupHistoricalYears() {
            const baseYear = parseInt(document.getElementById('baseYear').value) || 2023;
            document.getElementById('histYear1').textContent = baseYear - 2;
            document.getElementById('histYear2').textContent = baseYear - 1;
            document.getElementById('histYear3').textContent = baseYear;
        }

        // AI Configuration
        function toggleAIConfig() {
            document.getElementById('aiConfigModal').classList.toggle('hidden');
        }

        function closeAIConfig() {
            document.getElementById('aiConfigModal').classList.add('hidden');
        }

        function toggleApiVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function updateAIFields() {
            const provider = document.getElementById('aiProvider').value;
            const instructions = document.getElementById('apiInstructions');
            
            if (provider === 'openai') {
                instructions.innerHTML = `
                    <li>Acesse platform.openai.com</li>
                    <li>Crie uma conta ou fa√ßa login</li>
                    <li>V√° em "API Keys" no menu lateral</li>
                    <li>Clique em "Create new secret key"</li>
                    <li>Copie e cole aqui</li>
                `;
                document.getElementById('aiModel').innerHTML = `
                    <option value="gpt-4">GPT-4 (Mais inteligente)</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Mais r√°pido)</option>
                `;
            } else if (provider === 'anthropic') {
                instructions.innerHTML = `
                    <li>Acesse console.anthropic.com</li>
                    <li>Crie uma conta</li>
                    <li>V√° em "API Keys"</li>
                    <li>Gere uma nova chave</li>
                    <li>Copie e cole aqui</li>
                `;
                document.getElementById('aiModel').innerHTML = `
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                `;
            }
        }

        function saveAIConfig() {
            aiConfig.provider = document.getElementById('aiProvider').value;
            aiConfig.apiKey = document.getElementById('apiKey').value;
            aiConfig.model = document.getElementById('aiModel').value;
            aiConfig.connected = true;
            
            document.getElementById('aiStatus').innerHTML = `
                <span class="pulse-ring w-2 h-2 bg-green-500 rounded-full block"></span>
                <span class="text-green-400">IA Conectada</span>
            `;
            
            closeAIConfig();
            localStorage.setItem('aiConfig', JSON.stringify(aiConfig));
        }

        // Historical Data Functions
        function autoFillHistorical() {
            const sector = document.getElementById('sector').value || 'outro';
            const ref = sectorData[sector];
            const baseYear = parseInt(document.getElementById('baseYear').value) || 2023;
            
            // Generate realistic 3-year history with growth trend
            const year3Revenue = 10000000; // 10M base
            const growth = 1 + (ref.growth / 100);
            
            for (let i = 1; i <= 3; i++) {
                const year = i;
                const revenue = year3Revenue / Math.pow(growth, 3 - i);
                const cost = revenue * (1 - ref.margin/100) * 0.85;
                const ebitda = revenue - cost;
                const dep = revenue * (ref.dep / 100);
                const ebit = ebitda - dep;
                const tax = Math.max(0, ebit * 0.34);
                const ncg = revenue * (ref.ncg / 100) * 0.1;
                const capex = revenue * (ref.capex / 100);
                
                document.getElementById(`rev${year}`).value = revenue.toFixed(2);
                document.getElementById(`cost${year}`).value = cost.toFixed(2);
                document.getElementById(`dep${year}`).value = dep.toFixed(2);
                document.getElementById(`tax${year}`).value = tax.toFixed(2);
                document.getElementById(`ncg${year}`).value = ncg.toFixed(2);
                document.getElementById(`capex${year}`).value = capex.toFixed(2);
            }
            
            calculateHistorical();
        }

        function calculateHistorical() {
            const data = { years: [], revenue: [], ebitda: [], ebit: [], tax: [], ncg: [], capex: [], dep: [] };
            
            for (let i = 1; i <= 3; i++) {
                const rev = parseFloat(document.getElementById(`rev${i}`).value) || 0;
                const cost = parseFloat(document.getElementById(`cost${i}`).value) || 0;
                const dep = parseFloat(document.getElementById(`dep${i}`).value) || 0;
                const tax = parseFloat(document.getElementById(`tax${i}`).value) || 0;
                const ncg = parseFloat(document.getElementById(`ncg${i}`).value) || 0;
                const capex = parseFloat(document.getElementById(`capex${i}`).value) || 0;
                
                const ebitda = rev - cost;
                const ebit = ebitda - dep;
                
                document.getElementById(`ebitda${i}`).textContent = formatCurrency(ebitda);
                document.getElementById(`ebit${i}`).textContent = formatCurrency(ebit);
                
                data.years.push(i);
                data.revenue.push(rev);
                data.ebitda.push(ebitda);
                data.ebit.push(ebit);
                data.tax.push(tax);
                data.ncg.push(ncg);
                data.capex.push(capex);
                data.dep.push(dep);
            }
            
            // Calculate metrics
            const cagr = Math.pow(data.revenue[2] / data.revenue[0], 0.5) - 1;
            const avgEbitdaMargin = (data.ebitda.reduce((a, b) => a + b, 0) / data.revenue.reduce((a, b) => a + b, 0)) * 100;
            const avgCapexRate = (data.capex.reduce((a, b) => a + b, 0) / data.revenue.reduce((a, b) => a + b, 0)) * 100;
            
            document.getElementById('cagrRevenue').textContent = (cagr * 100).toFixed(2) + '%';
            document.getElementById('avgEbitdaMargin').textContent = avgEbitdaMargin.toFixed(2) + '%';
            document.getElementById('avgCapexRate').textContent = avgCapexRate.toFixed(2) + '%';
            
            historicalData = data;
        }

        // Projection Functions
        function showProjectionYear(year) {
            // Hide all forms
            document.querySelectorAll('.projection-form').forEach(form => {
                form.classList.add('hidden');
            });
            // Show selected
            document.getElementById(`projection-year-${year}`).classList.remove('hidden');
            
            // Update tabs
            document.querySelectorAll('[id^="tab-year-"]').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('text-slate-400');
            });
            document.getElementById(`tab-year-${year}`).classList.add('tab-active');
            document.getElementById(`tab-year-${year}`).classList.remove('text-slate-400');
        }

        function suggestProjections(scenario) {
            if (!historicalData.revenue) {
                alert('Preencha os dados hist√≥ricos primeiro!');
                return;
            }
            
            const sector = document.getElementById('sector').value || 'outro';
            const ref = sectorData[sector];
            const lastGrowth = parseFloat(document.getElementById('cagrRevenue').textContent) || ref.growth;
            
            let growthRates = [];
            
            switch(scenario) {
                case 'conservative':
                    growthRates = [lastGrowth * 0.6, lastGrowth * 0.5, lastGrowth * 0.4, 4, 3];
                    break;
                case 'optimistic':
                    growthRates = [lastGrowth * 1.3, lastGrowth * 1.2, lastGrowth * 1.1, 8, 5];
                    break;
                case 'base':
                default:
                    // Convergence to perpetuity growth
                    for (let i = 1; i <= 5; i++) {
                        const weight = i / 5;
                        growthRates.push(lastGrowth * (1 - weight) + 3 * weight);
                    }
            }
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`growth${i}`).value = growthRates[i-1].toFixed(2);
                document.getElementById(`margin${i}`).value = ref.margin.toFixed(2);
                document.getElementById(`depRate${i}`).value = ref.dep.toFixed(2);
                document.getElementById(`ncgRate${i}`).value = ref.ncg.toFixed(2);
                document.getElementById(`capexRate${i}`).value = ref.capex.toFixed(2);
                
                // Update summary
                document.getElementById(`sum-growth${i}`).textContent = growthRates[i-1].toFixed(1) + '%';
                document.getElementById(`sum-margin${i}`).textContent = ref.margin.toFixed(1) + '%';
            }
        }

        function saveProjections() {
            projections = { growth: [], margin: [], depRate: [], ncgRate: [], capexRate: [], taxRate: [] };
            
            for (let i = 1; i <= 5; i++) {
                projections.growth.push(parseFloat(document.getElementById(`growth${i}`).value) || 0);
                projections.margin.push(parseFloat(document.getElementById(`margin${i}`).value) || 0);
                projections.depRate.push(parseFloat(document.getElementById(`depRate${i}`).value) || 0);
                projections.ncgRate.push(parseFloat(document.getElementById(`ncgRate${i}`).value) || 0);
                projections.capexRate.push(parseFloat(document.getElementById(`capexRate${i}`).value) || 0);
                projections.taxRate.push(parseFloat(document.getElementById(`taxRate${i}`).value) || 34);
            }
        }

        // WACC Calculation
        function calculateWACC() {
            const rf = parseFloat(document.getElementById('rf').value) || 0;
            const rpm = parseFloat(document.getElementById('rpm').value) || 0;
            const beta = parseFloat(document.getElementById('beta').value) || 0;
            const kd_bruto = parseFloat(document.getElementById('kd').value) || 0;
            const tax = parseFloat(document.getElementById('taxShield').value) || 0;
            const debtWeight = parseFloat(document.getElementById('debtWeight').value) || 0;
            
            ke = rf + (beta * rpm);
            kd = kd_bruto * (1 - tax/100);
            const equityWeight = 100 - debtWeight;
            wacc = ((equityWeight/100) * ke) + ((debtWeight/100) * kd);
            
            document.getElementById('keResult').textContent = ke.toFixed(2) + '%';
            document.getElementById('kdResult').textContent = kd.toFixed(2) + '%';
            document.getElementById('waccResult').textContent = wacc.toFixed(2) + '%';
            
            const g = parseFloat(document.getElementById('growthPerpetuity').value) || 0;
            const check = document.getElementById('perpetuityCheck');
            if (g >= wacc) {
                check.textContent = '‚úó Crescimento n√£o pode ser maior ou igual ao WACC!';
                check.className = 'text-red-400 font-bold';
            } else {
                check.textContent = '‚úì Cen√°rio v√°lido';
                check.className = 'text-green-400';
            }
        }

        // Valuation Calculation
        function calculateValuation() {
            if (!historicalData.revenue) {
                alert('Preencha os dados hist√≥ricos primeiro!');
                return;
            }
            
            saveProjections();
            
            const lastRevenue = historicalData.revenue[2];
            const waccDecimal = wacc / 100;
            const g = parseFloat(document.getElementById('growthPerpetuity').value) || 3;
            const gDecimal = g / 100;
            
            let revenues = [lastRevenue];
            let fcfs = [];
            let details = [];
            
            for (let i = 0; i < 5; i++) {
                const growth = projections.growth[i] / 100;
                const margin = projections.margin[i] / 100;
                const depRate = projections.depRate[i] / 100;
                const ncgRate = projections.ncgRate[i] / 100;
                const capexRate = projections.capexRate[i] / 100;
                const taxRate = projections.taxRate[i] / 100;
                
                const revenue = revenues[i] * (1 + growth);
                const ebitda = revenue * margin;
                const dep = revenue * depRate;
                const ebit = ebitda - dep;
                const tax = Math.max(0, ebit * taxRate);
                const nopat = ebit - tax;
                const ncg = revenue * ncgRate * growth;
                const capex = revenue * capexRate;
                const fcf = nopat + dep - capex - ncg;
                
                revenues.push(revenue);
                fcfs.push(fcf);
                details.push({rev: revenue, ebitda, dep, ebit, tax, nopat, ncg, capex, fcf});
            }
            
            // Terminal Value
            const terminalFCF = fcfs[4] * (1 + gDecimal);
            const terminalValue = terminalFCF / (waccDecimal - gDecimal);
            
            // NPV
            let npvExplicit = 0;
            for (let i = 0; i < 5; i++) {
                npvExplicit += fcfs[i] / Math.pow(1 + waccDecimal, i + 1);
            }
            const pvTerminal = terminalValue / Math.pow(1 + waccDecimal, 5);
            const enterpriseValue = npvExplicit + pvTerminal;
            
            // Update UI
            document.getElementById('evResult').textContent = formatCurrency(enterpriseValue);
            document.getElementById('terminalValueResult').textContent = formatCurrency(pvTerminal);
            document.getElementById('perpetuityPercent').textContent = ((pvTerminal / enterpriseValue) * 100).toFixed(1) + '%';
            document.getElementById('evEbitdaMultiple').textContent = (enterpriseValue / details[4].ebitda).toFixed(2) + 'x';
            
            // Populate table
            const tbody = document.getElementById('fcfTableBody');
            tbody.innerHTML = '';
            const rows = [
                ['Receita', details.map(d => d.rev)],
                ['EBITDA', details.map(d => d.ebitda)],
                ['(-) Deprecia√ß√£o', details.map(d => d.dep)],
                ['= EBIT', details.map(d => d.ebit)],
                ['(-) IR', details.map(d => d.tax)],
                ['= NOPAT', details.map(d => d.nopat)],
                ['(+) Deprecia√ß√£o', details.map(d => d.dep)],
                ['(-) CAPEX', details.map(d => d.capex)],
                ['(-) Var. NCG', details.map(d => d.ncg)],
                ['= FCF', details.map(d => d.fcf)]
            ];
            
            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700/50';
                const isTotal = row[0].includes('=');
                tr.innerHTML = `<td class="py-2 px-2 font-medium ${isTotal ? 'text-blue-400' : 'text-slate-300'}">${row[0]}</td>`;
                row[1].forEach(val => {
                    tr.innerHTML += `<td class="py-2 px-2 text-right ${isTotal ? 'text-blue-400 font-semibold' : 'text-slate-400'}">${formatCurrency(val)}</td>`;
                });
                tbody.appendChild(tr);
            });
            
            // Charts
            updateCharts(fcfs, npvExplicit, pvTerminal);
            
            // Sensibility
            generateSensibilityTable(terminalFCF, waccDecimal, gDecimal, details[4].ebitda);
            
            // Store data
            valuationData = {
                company: document.getElementById('companyName').value,
                sector: document.getElementById('sector').value,
                baseYear: document.getElementById('baseYear').value,
                historical: historicalData,
                projections: projections,
                wacc, ke, kd, growthPerp: g,
                fcfs, terminalValue, enterpriseValue, pvTerminal,
                details, npvExplicit
            };
        }

        function updateCharts(fcfs, npvExplicit, pvTerminal) {
            const ctx1 = document.getElementById('fcfChart').getContext('2d');
            if (fcfChartInstance) fcfChartInstance.destroy();
            
            fcfChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Ano 1', 'Ano 2', 'Ano 3', 'Ano 4', 'Ano 5'],
                    datasets: [{
                        label: 'FCF',
                        data: fcfs.map(f => f/1000000),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            ticks: { 
                                color: '#94a3b8',
                                callback: v => 'R$ ' + v.toFixed(1) + 'M'
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
            
            const ctx2 = document.getElementById('valueChart').getContext('2d');
            if (valueChartInstance) valueChartInstance.destroy();
            
            valueChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Per√≠odo Expl√≠cito', 'Valor Terminal'],
                    datasets: [{
                        data: [npvExplicit, pvTerminal],
                        backgroundColor: ['rgba(102, 126, 234, 0.8)', 'rgba(118, 75, 162, 0.8)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function generateSensibilityTable(terminalFCF, baseWacc, baseG, lastEbitda) {
            const waccs = [baseWacc - 0.02, baseWacc - 0.01, baseWacc, baseWacc + 0.01, baseWacc + 0.02];
            const growths = [baseG - 0.01, baseG, baseG + 0.01];
            
            const table = document.getElementById('sensibilityTable');
            table.innerHTML = '';
            
            let header = '<tr><th class="p-2 border border-slate-700 bg-slate-800">WACC \\ g</th>';
            growths.forEach(g => {
                header += `<th class="p-2 border border-slate-700 bg-slate-800">${(g * 100).toFixed(1)}%</th>`;
            });
            header += '</tr>';
            table.innerHTML += header;
            
            waccs.forEach(w => {
                let row = `<tr><td class="p-2 border border-slate-700 bg-slate-800 font-semibold">${(w * 100).toFixed(1)}%</td>`;
                growths.forEach(g => {
                    let ev = 0;
                    if (g < w) {
                        const tv = terminalFCF / (w - g);
                        ev = tv / Math.pow(1 + w, 5);
                        for (let i = 0; i < 5; i++) {
                            ev += valuationData.fcfs[i] / Math.pow(1 + w, i + 1);
                        }
                    }
                    const multiple = ev / lastEbitda;
                    const color = multiple < 0 ? 'text-red-400' : multiple > 15 ? 'text-green-400' : 'text-blue-400';
                    row += `<td class="p-2 border border-slate-700 ${color}">${(ev/1000000).toFixed(1)}M</td>`;
                });
                row += '</tr>';
                table.innerHTML += row;
            });
        }

        // AI Integration
        async function callAI(prompt) {
            if (!aiConfig.connected) throw new Error('IA n√£o configurada');
            
            const messages = [
                {
                    role: 'system',
                    content: `Voc√™ √© um consultor s√™nior de valuation e M&A com 20 anos de experi√™ncia. 
                    Analise o valuation apresentado de forma cr√≠tica, profissional e construtiva.
                    Responda em portugu√™s do Brasil. Seja direto, t√©cnico mas acess√≠vel.`
                },
                { role: 'user', content: prompt }
            ];
            
            if (aiConfig.provider === 'openai') {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro na API');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            throw new Error('Provedor n√£o suportado');
        }

        async function requestAnalysis(type) {
            if (!valuationData.enterpriseValue) {
                alert('Calcule o valuation primeiro!');
                return;
            }
            
            const loadingId = addMessage('ai', '<span class="typing-indicator">Analisando</span>');
            
            try {
                let prompt = '';
                const d = valuationData;
                
                switch(type) {
                    case 'critique':
                        prompt = `Critique severamente este valuation:
                        
                        EMPRESA: ${d.company} (Setor: ${d.sector})
                        
                        HIST√ìRICO (3 anos):
                        - CAGR Receita: ${((Math.pow(d.historical.revenue[2]/d.historical.revenue[0], 0.5)-1)*100).toFixed(1)}%
                        - Margem EBITDA m√©dia: ${((d.historical.ebitda.reduce((a,b)=>a+b,0)/d.historical.revenue.reduce((a,b)=>a+b,0))*100).toFixed(1)}%
                        
                        PROJE√á√ïES (5 anos, VARI√ÅVEIS):
                        ${d.projections.growth.map((g, i) => `Ano ${i+1}: Cresc ${g.toFixed(1)}%, Margem ${d.projections.margin[i].toFixed(1)}%`).join('\n')}
                        
                        WACC: ${d.wacc.toFixed(2)}% | Cresc. Perp√©tuo: ${d.growthPerp}%
                        
                        RESULTADO: EV = R$ ${(d.enterpriseValue/1000000).toFixed(2)}M
                        
                        Identifique falhas, otimismo excessivo, riscos n√£o considerados.`;
                        break;
                        
                    case 'optimize':
                        prompt = `Como otimizar este valuation?
                        
                        Cen√°rio atual: EV de R$ ${(d.enterpriseValue/1000000).toFixed(2)}M
                        
                        Proje√ß√µes atuais: ${d.projections.growth.map((g, i) => `A${i+1}:${g.toFixed(0)}%`).join(', ')}
                        
                        Sugira:
                        1. Alavancas operacionais (margem, crescimento, NCG)
                        2. Estrutura de capital √≥tima (WACC atual: ${d.wacc.toFixed(2)}%)
                        3. Estrat√©gias de cria√ß√£o de valor
                        
                        Quantifique o impacto de cada sugest√£o.`;
                        break;
                        
                    case 'scenarios':
                        prompt = `An√°lise de cen√°rios para ${d.company}:
                        
                        Base: EV = R$ ${(d.enterpriseValue/1000000).toFixed(2)}M
                        
                        Crie 3 cen√°rios (Pessimista, Base, Otimista) variando:
                        - Crescimento m√©dio dos 5 anos
                        - Margem EBITDA terminal
                        - WACC
                        
                        Para cada cen√°rio, calcule o novo EV e explique as premissas.`;
                        break;
                }
                
                const response = await callAI(prompt);
                removeMessage(loadingId);
                addMessage('ai', response);
                parseInsights(response, type);
                
            } catch (error) {
                removeMessage(loadingId);
                addMessage('ai', `Erro: ${error.message}`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            
            addMessage('user', text);
            input.value = '';
            
            const loadingId = addMessage('ai', '<span class="typing-indicator">Pensando</span>');
            
            try {
                const context = `Valuation atual: ${valuationData.company}, EV R$ ${((valuationData.enterpriseValue||0)/1000000).toFixed(2)}M. ${text}`;
                const response = await callAI(context);
                removeMessage(loadingId);
                addMessage('ai', response);
            } catch (error) {
                removeMessage(loadingId);
                addMessage('ai', `Erro: ${error.message}`);
            }
        }

        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-message ' + (role === 'user' ? 'ml-12' : '');
            
            const isUser = role === 'user';
            div.innerHTML = `
                <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-full ${isUser ? 'bg-slate-700' : 'bg-gradient-to-br from-blue-500 to-purple-600'} flex items-center justify-center flex-shrink-0">
                        <i class="fas ${isUser ? 'fa-user' : 'fa-robot'} text-xs"></i>
                    </div>
                    <div class="flex-1 ${isUser ? 'text-right' : ''}">
                        <div class="inline-block max-w-full ${isUser ? 'bg-blue-600' : 'bg-slate-800'} p-4 rounded-xl border ${isUser ? 'border-blue-500' : 'border-slate-700'} text-sm text-slate-200 whitespace-pre-wrap">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function parseInsights(text, type) {
            const insightsContainer = document.getElementById('insightsContainer');
            const risksContainer = document.getElementById('risksContainer');
            const opportunitiesContainer = document.getElementById('opportunitiesContainer');
            
            insightsContainer.innerHTML = '';
            risksContainer.innerHTML = '';
            opportunitiesContainer.innerHTML = '';
            
            const lines = text.split('\n').filter(l => l.trim());
            
            lines.forEach(line => {
                if (line.match(/risco|problema|alerta|preocupa√ß√£o|falha/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card risk-high p-3 rounded-lg';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line.replace(/^[0-9.-]+\s*/, '')}</p>`;
                    risksContainer.appendChild(div);
                } else if (line.match(/oportunidade|melhoria|otimizar|aumentar|estrat√©gia|sugest√£o/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card risk-low p-3 rounded-lg';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line.replace(/^[0-9.-]+\s*/, '')}</p>`;
                    opportunitiesContainer.appendChild(div);
                } else if (line.match(/nota|score|conclus√£o|resumo|avalia√ß√£o/i)) {
                    const div = document.createElement('div');
                    div.className = 'insight-card p-3 rounded-lg bg-blue-500/10 border-l-2 border-blue-500';
                    div.innerHTML = `<p class="text-sm text-slate-300">${line}</p>`;
                    insightsContainer.appendChild(div);
                }
            });
            
            if (risksContainer.children.length === 0) {
                risksContainer.innerHTML = '<div class="text-slate-500 text-sm">Nenhum risco cr√≠tico identificado.</div>';
            }
            if (opportunitiesContainer.children.length === 0) {
                opportunitiesContainer.innerHTML = '<div class="text-slate-500 text-sm">Solicite an√°lise de otimiza√ß√£o.</div>';
            }
        }

        async function generateFullReport() {
            if (!aiConfig.connected) {
                alert('Configure a IA primeiro!');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            btn.disabled = true;
            
            try {
                const d = valuationData;
                const prompt = `Gere relat√≥rio profissional de valuation:
                
                EMPRESA: ${d.company}
                SETOR: ${d.sector}
                DATA BASE: ${d.baseYear}
                
                HIST√ìRICO 3 ANOS:
                - Receita: ${d.historical.revenue.map(r => (r/1000000).toFixed(1)+'M').join(' ‚Üí ')}
                - EBITDA: ${d.historical.ebitda.map(e => (e/1000000).toFixed(1)+'M').join(' ‚Üí ')}
                
                PROJE√á√ïES 5 ANOS (VARI√ÅVEIS):
                ${d.projections.growth.map((g, i) => `Ano ${i+1}: ${g.toFixed(1)}% cresc, ${d.projections.margin[i].toFixed(1)}% margem`).join('\n')}
                
                WACC: ${d.wacc.toFixed(2)}% | Perp√©tuo: ${d.growthPerp}%
                
                RESULTADO: EV R$ ${(d.enterpriseValue/1000000).toFixed(2)}M
                
                Estruture em: 1.Executive Summary 2.Premissas 3.An√°lise Hist√≥rica 4.Proje√ß√µes 5.Sensibilidade 6.Conclus√£o e Recomenda√ß√£o`;
                
                const report = await callAI(prompt);
                
                const blob = new Blob([report], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Valuation_${d.company.replace(/\s+/g, '_')}_IA.md`;
                a.click();
                
                addMessage('ai', '‚úÖ Relat√≥rio completo gerado! Verifique sua pasta de downloads.');
                
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function prepareAIAnalysis() {
            if (!aiConfig.connected) {
                if (confirm('Configure a IA para an√°lise avan√ßada. Deseja configurar agora?')) {
                    toggleAIConfig();
                }
            }
        }

        // Utilities
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('aiConfig');
            if (saved) {
                aiConfig = JSON.parse(saved);
                if (aiConfig.connected) {
                    document.getElementById('aiStatus').innerHTML = `
                        <span class="pulse-ring w-2 h-2 bg-green-500 rounded-full block"></span>
                        <span class="text-green-400">IA Conectada</span>
                    `;
                }
            }
            
            // Auto-calculate WACC on input change
            document.querySelectorAll('#step4 input').forEach(input => {
                input.addEventListener('input', calculateWACC);
            });
        });

        window.addEventListener('beforeunload', () => {
            if (aiConfig.apiKey) {
                localStorage.setItem('aiConfig', JSON.stringify(aiConfig));
            }
        });
    </script>
</body>
</html>
